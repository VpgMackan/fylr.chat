// packages/backend/prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  EXPIRED
  INACTIVE
}

enum UserRole {
  FREE
  PRO
}

enum UsageRecordFeatrue {
  SUMMARY_GENERATION_MONTHLY
  PODCATS_GENERATION_MONTHLY
  CHAT_MESSAGES_DAILY
  CHAT_AGENTIC_MESSAGES_DAILY
  SOURCE_UPLOAD_DAILY
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  password String
  name     String

  role UserRole @default(FREE)

  libraries     Library[]
  conversations Conversation[]
  summary       Summary[]
  podcast       Podcast[]
  refreshTokens RefreshToken[]
  Subscription  Subscription?
  usageRecords  UsageRecord[]

  @@map("Users")
}

model Subscription {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status                   SubscriptionStatus @default(INACTIVE)
  expiresAt                DateTime?          @map("expires_at")
  remainingDurationOnPause Int?               @map("remaining_duration_on_pause")

  pausedAt      DateTime? @map("paused_at")
  lastResumedAt DateTime? @map("last_resumed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("Subscriptions")
}

model UsageRecord {
  id          String             @id @default(uuid())
  userId      String             @map("user_id")
  feature     UsageRecordFeatrue
  usageCount  Int                @default(1) @map("usage_count")
  periodStart DateTime           @map("period_start")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feature])
  @@map("UsageRecords")
}

model RefreshToken {
  id          String   @id @default(uuid())
  hashedToken String   @unique @map("hashed_token")
  userId      String   @map("user_id")
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("RefreshTokens")
}

model Library {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  icon                  String
  description           String   @db.Text
  createdAt             DateTime @default(now()) @map("created_at")
  tags                  String[] @db.Text
  title                 String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sources               Source[]
  defaultEmbeddingModel String   @map("default_embedding_model")

  @@map("Libraries")
}

model Source {
  id         String   @id @default(uuid())
  libraryId  String   @map("library_id")
  name       String
  mimeType   String   @map("type")
  url        String
  size       Int
  uploadTime DateTime @default(now()) @map("upload_time")
  jobKey     String   @map("job_key")
  status     String   @db.Text
  library    Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  vectors    Vector[]

  ingestorType    String?
  ingestorVersion String?

  conversations Conversation[] @relation("ConversationSources")
  summaries     Summary[]      @relation("SummarySources")
  podcasts      Podcast[]      @relation("PodcastSources")

  @@map("Sources")
}

model Vector {
  id         String                      @id @default(uuid())
  fileId     String                      @map("file_id")
  embedding  Unsupported("vector(1024)")
  content    String                      @db.Text
  source     Source                      @relation(fields: [fileId], references: [id], onDelete: Cascade)
  chunkIndex Int                         @map("chunk_index")

  @@map("Vectors")
}

model Summary {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  title     String
  createdAt DateTime         @default(now()) @map("created_at")
  length    Int
  generated String?          @db.Text
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  episodes  SummaryEpisode[]
  sources   Source[]         @relation("SummarySources")

  @@map("Summary")
}

model SummaryEpisode {
  id        String   @id @default(uuid())
  summaryId String   @map("summary_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  title     String
  focus     String?  @db.Text
  summary   Summary  @relation(fields: [summaryId], references: [id], onDelete: Cascade)

  @@map("SummaryEpisode")
}

model Podcast {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  title     String
  createdAt DateTime         @default(now()) @map("created_at")
  length    Int
  generated String?          @db.Text
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  episodes  PodcastEpisode[]
  sources   Source[]         @relation("PodcastSources")

  @@map("Podcast")
}

model PodcastEpisode {
  id        String   @id @default(uuid())
  podcastId String   @map("podcast_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  title     String
  focus     String?  @db.Text
  audioKey  String?  @map("audio_key") @db.Text
  podcast   Podcast  @relation(fields: [podcastId], references: [id], onDelete: Cascade)

  @@map("PodcastEpisode")
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  metadata  Json
  createdAt DateTime  @default(now()) @map("created_at")
  title     String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
  sources   Source[]  @relation("ConversationSources")

  @@map("Conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  createdAt      DateTime @default(now()) @map("created_at")
  role           String

  content    String? @db.Text
  reasoning  String? @db.Text
  toolCalls  Json?   @map("tool_calls")
  toolResult Json?   @map("tool_result")

  toolCallId String? @map("tool_call_id")

  metadata Json?

  // Parent message ID - for grouping thoughts and responses to a user message
  parentMessageId String?   @map("parent_message_id")
  parentMessage   Message?  @relation("MessageThread", fields: [parentMessageId], references: [id], onDelete: Cascade)
  childMessages   Message[] @relation("MessageThread")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("Messages")
}
